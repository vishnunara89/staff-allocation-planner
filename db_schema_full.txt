--- users ---
CREATE TABLE users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT,
      phone TEXT,
      username TEXT UNIQUE NOT NULL,
      password TEXT NOT NULL,
      role TEXT CHECK(role IN ('admin', 'manager')) NOT NULL
    )

--- sqlite_sequence ---
CREATE TABLE sqlite_sequence(name,seq)

--- plans ---
CREATE TABLE plans (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      status TEXT CHECK(status IN ('active', 'inactive')) 
        NOT NULL DEFAULT 'inactive',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )

--- manager_venues ---
CREATE TABLE manager_venues (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      manager_id INTEGER NOT NULL,
      venue_name TEXT NOT NULL, venue_id INTEGER REFERENCES venues(id) ON DELETE CASCADE,
      UNIQUE(manager_id, venue_name),
      FOREIGN KEY (manager_id) REFERENCES users(id) ON DELETE CASCADE
    )

--- venues ---
CREATE TABLE venues (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        type TEXT NOT NULL,
        default_service_style TEXT NOT NULL,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )

--- staffing_rules ---
CREATE TABLE staffing_rules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        venue_id INTEGER NOT NULL,
        role_id INTEGER NOT NULL,
        min_required INTEGER NOT NULL DEFAULT 0,
        max_allowed INTEGER,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

        FOREIGN KEY (venue_id) REFERENCES venues(id) ON DELETE CASCADE
      )

--- employees ---
CREATE TABLE employees (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    full_name TEXT NOT NULL,
    primary_role_id INTEGER NOT NULL,
    home_base_venue_id INTEGER,
    notes TEXT,
    availability_status TEXT DEFAULT 'available',
    english_proficiency TEXT,
    other_languages TEXT,
    special_skills TEXT,
    employment_type TEXT, secondary_roles TEXT DEFAULT '[]', experience_tags TEXT DEFAULT '[]', employee_role TEXT DEFAULT 'staff',
    FOREIGN KEY (primary_role_id) REFERENCES roles(id)
  )

--- roles ---
CREATE TABLE roles (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT UNIQUE NOT NULL
    )

--- staff ---
CREATE TABLE staff (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      full_name TEXT NOT NULL,
      primary_role_id INTEGER,
      secondary_roles TEXT, -- JSON array of role IDs
      english_proficiency TEXT DEFAULT 'basic',
      other_languages TEXT, -- JSON object { language: proficiency }
      special_skills TEXT, -- JSON array of strings
      experience_tags TEXT, -- JSON array of strings
      home_base_venue_id INTEGER,
      employment_type TEXT DEFAULT 'internal', -- internal, freelance, agency
      availability_status TEXT DEFAULT 'available', -- available, off, leave
      notes TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      
      FOREIGN KEY (primary_role_id) REFERENCES roles(id) ON DELETE SET NULL,
      FOREIGN KEY (home_base_venue_id) REFERENCES venues(id) ON DELETE SET NULL
    )

--- events ---
CREATE TABLE events (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      date TEXT NOT NULL,
      venue_id INTEGER NOT NULL,
      guest_count INTEGER NOT NULL,
      service_style_override TEXT,
      special_requirements TEXT,
      priority TEXT DEFAULT 'normal',
      start_time TEXT,
      end_time TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (venue_id) REFERENCES venues(id) ON DELETE CASCADE
    )

--- staffing_plans ---
CREATE TABLE staffing_plans (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      event_date TEXT NOT NULL,
      venue_id INTEGER NOT NULL,
      staff_id INTEGER,
      assigned_role_id INTEGER,
      status TEXT DEFAULT 'proposed',
      reasoning TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

      FOREIGN KEY (venue_id) REFERENCES venues(id) ON DELETE CASCADE,
      FOREIGN KEY (staff_id) REFERENCES staff(id) ON DELETE SET NULL,
      FOREIGN KEY (assigned_role_id) REFERENCES roles(id) ON DELETE SET NULL
    )

--- venue_manning_tables ---
CREATE TABLE venue_manning_tables (
      venue_id INTEGER NOT NULL,
      department TEXT NOT NULL,
      config_json TEXT,
      updated_at TEXT,
      PRIMARY KEY (venue_id, department),
      FOREIGN KEY (venue_id) REFERENCES venues(id) ON DELETE CASCADE
    )

--- manning_brackets ---
CREATE TABLE manning_brackets (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      venue_id INTEGER NOT NULL,
      department TEXT NOT NULL,
      guest_min INTEGER NOT NULL,
      guest_max INTEGER NOT NULL,
      counts_json TEXT,
      notes TEXT,
      source TEXT DEFAULT 'manual',
      updated_at TEXT,
      FOREIGN KEY (venue_id) REFERENCES venues(id) ON DELETE CASCADE
    )

--- requirements_catalog ---
CREATE TABLE requirements_catalog (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      type TEXT NOT NULL,
      value TEXT NOT NULL
    )

--- skills ---
CREATE TABLE skills (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL
      )
